image: node:20

stages:
  - lint
  - test
  - build

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
    - .npm/

before_script:
  - npm ci --cache .npm --prefer-offline

eslint:
  stage: lint
  script:
    - npm run lint

type-check:
  stage: lint
  script:
    - npx vue-tsc --build --force

vitest:
  stage: test
  script:
    - npx vitest run --coverage
  artifacts:
    when: always
    paths:
      - coverage/
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml

cypress:
  stage: test
  image: cypress/browsers:node-20.18.1-chrome-130.0.6723.69-1-ff-131.0.3-edge-130.0.2849.56-1
  script:
    - npm ci
    - npx vite --port 3001 &
    - npx wait-on http://localhost:3001 --timeout 30000
    - npx cypress run
  artifacts:
    when: on_failure
    paths:
      - cypress/screenshots/
      - cypress/videos/

build:
  stage: build
  script:
    - npm run build
  artifacts:
    paths:
      - dist/
